//CONTROLLER PER LA GESTIONE DEI SERVIZI ANTIMALWARES

const express = require('express');
const router = express.Router();
const formidable = require('formidable');
const config = require('../../../config')

/*
Per virus-total bisogna includere l'header x-apikey in ogni richiesta
Le risposte sono in formato JSON

Limiti:
	Request rate:	4 lookups / min
	Daily quota:	500 lookups / day
	Monthly quota:	15.50 K lookups / month
*/


//File upload
router.post('/', async function(req, res){

	let form = new formidable.IncomingForm();

	form.parse(req, async function (error, fields, files) {
		if(error){
			res.status(400).json({status: 400, message: error}) 
		} else {
			var fileID = -1;
			let fileSize = (files.filetoupload._writeStream.bytesWritten / Math.pow(10,6)).toFixed(3); //From Bytes to MegaBytes
			let filePath = files.filetoupload.filepath;
			let fileName = files.filetoupload.originalFilename;

			console.log("Name:" + fileName);
			console.log("Path: " + filePath);
			console.log("Size: " + fileSize + " MB");

			if(fileSize <= 32){
				//Upload Standard
				console.log("[Standard Upload]")

				fileID = await uploadFile('/files', filePath);

			} else {
				//Get Upload Link (MAX 200 MB)
				console.log("[Upload With Link]")

				var link = '/files';
				const sdk = require('api')('@virustotal/v3.0#qslw1jl4hdir5j');

				//Get Upload Link
				sdk['files-upload-url']({'x-apikey': config.VIRUS_TOTAL_KEY})
  				.then(res => console.log(res))
  				.catch(err => console.error(err));

  				//console.log("Link: " + link);

  				//fileID = await uploadFile(link, filePath);

			}

			console.log("FileID: " + fileID);
			res.end("OK - " + fileID);
		}
    });
})

async function uploadFile(link, fileName){
	const sdk = require('api')('@virustotal/v3.0#7r415jxl3ofbsw8');

	await sdk.post(link, {
	  file: fileName
	}, {
	  Accept: 'application/json',
	  'x-apikey': config.VIRUS_TOTAL_KEY,
	  'Content-Type': 'multipart/form-data; boundary=---011000010111000001101001'
	})
	.then(res => {return res.data.id})
	.catch(err => console.error(err));
}

module.exports = router