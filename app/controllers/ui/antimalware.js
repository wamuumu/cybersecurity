var express = require('express');
var router = express.Router();
const axios = require('axios');
const FormData = require('form-data');
const formidable = require('formidable');
const fs = require('fs');

//Routing for pages

router.get('/', async function(req, res) {
    res.render('antimalware/antimalware_upload');
})

router.post('/analyze', async function(req, res) {

    //forward the request to API
    var data = { status: 200 };

    const formdata = new FormData();
    let form = new formidable.IncomingForm();

    form.parse(req, async function (error, fields, files) {

        let filePath = files.filetoupload.filepath;
        let fileName = files.filetoupload.originalFilename;
        let url = req.protocol + '://' + req.get('host') + '/api/antimalware/analyze';

        if(fileName != ""){
            const file = fs.createReadStream(filePath);
            formdata.append('filetoupload', file, fileName);

            await axios.post(url, formdata, {
                headers: {
                    maxContentLength: Infinity,
                    maxBodyLength: Infinity,
                    'Content-Type': 'multipart/form-data; boundary=' + formdata.getBoundary()
                }
            })
            .then(res => data = res.data)
            .catch(err => { data.status = err.response.data.status; data.text = err.response.data.message || "" })
        } else{
            data.status = 404;
            data.text = "File Not Found"
            console.error(data.text)
        }

        res.render('antimalware/antimalware_result', { data: data })
    });
})

module.exports = router