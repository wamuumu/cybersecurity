var express = require('express');
var router = express.Router();
const axios = require('axios');
const FormData = require('form-data');
const formidable = require('formidable');
const fs = require('fs');

//Routing for pages

router.get('/', async function(req, res) {
    
    if(!req.isAuthenticated()){
        res.render('common/error', { status:  401, message: "You need to login to access this service", loggedUser: req.isAuthenticated() });
        return;
    }

    var data = { status: parseInt(req.query.status) || 200, error: "Missing files" }
    res.render('antimalware/antimalware_upload', { data: data, loggedUser: req.isAuthenticated()});
})

router.post('/analyze', async function(req, res) {

    if(!req.isAuthenticated()){
        res.render('common/error', { status:  401, message: "You need to login to access this service", loggedUser: req.isAuthenticated() });
        return;
    }

    //forward the request to API
    var data = {};

    const formdata = new FormData();

    let form = new formidable.IncomingForm();

    form.parse(req, async function (error, fields, files) {

        if(error){
            console.log(error.name + ": " + error.message)
            res.redirect('/antimalware?status=404')

        } else if(!isEmpty(files)){
            let filePath = files.filetoupload.filepath;
            let fileName = files.filetoupload.originalFilename;
            let mimetype = files.filetoupload.mimetype;
            let fileSize = (files.filetoupload._writeStream.bytesWritten / Math.pow(10,6)).toFixed(3); //From Bytes to MegaBytes
            let url = req.protocol + '://' + req.get('host') + '/api/antimalware/analyze';

            if(fileName != ""){
                const file = fs.createReadStream(filePath);
                formdata.append('filetoupload', file, fileName);

                var info = { name: fileName, type: mimetype, size: fileSize}

                await axios.post(url, formdata, {
                    maxContentLength: Infinity,
                    maxBodyLength: Infinity,
                    headers: {
                        'Content-Type': 'multipart/form-data; boundary=' + formdata.getBoundary(),
                        "Cookie": "connect.sid=" + req.cookies["connect.sid"] +";"
                    }
                })
                .then(res => data = res.data)
                .catch(err => { data['status'] = err.response.status; data['error'] = err.response.statusText })
                
                res.render('antimalware/antimalware_result', { data: data, fileInfo: info, loggedUser: req.isAuthenticated() })

            } else{
                res.redirect('/antimalware?status=404')
            }
        } else {
            res.redirect('/antimalware?status=404')
        }
    });
})

function isEmpty(obj) {
    return Object.keys(obj).length === 0 || obj == undefined;
}

module.exports = router